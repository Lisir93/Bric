/*
 * Copyright (C) 2019 Wenting Zhang <zephray@outlook.com>
 * All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */

#include "fsl_dma.h"
#include "fsl_i2s.h"
#include "fsl_i2s_dma.h"

//#define AUDIO_I2S_MASTER_CLOCK_FREQUENCY (22579200)
#define AUDIO_I2S_MASTER_CLOCK_FREQUENCY (11289600)
#define AUDIO_I2S_TX (I2S7)
#define AUDIO_DMA (DMA0)
#define AUDIO_I2S_TX_CHANNEL (19)
#define ADUIO_I2S_TX_MODE (kI2S_MasterSlaveNormalMaster)
#define AUDIO_I2S_DATA (32) // 32 bit per sample
#define AUDIO_I2S_FRAME (64) // 64 bit per frame
#define I2S_CLOCK_DIVIDER (AUDIO_I2S_MASTER_CLOCK_FREQUENCY / 44100U / AUDIO_I2S_FRAME)

#if defined(__GNUC__) /* GNU Compiler */
#ifndef __ALIGN_END
#define __ALIGN_END __attribute__((aligned(4)))
#endif
#ifndef __ALIGN_BEGIN
#define __ALIGN_BEGIN
#endif
#else
#ifndef __ALIGN_END
#define __ALIGN_END
#endif
#ifndef __ALIGN_BEGIN
#if defined(__CC_ARM) || defined(__ARMCC_VERSION) /* ARM Compiler */
#define __ALIGN_BEGIN __attribute__((aligned(4)))
#elif defined(__ICCARM__) /* IAR Compiler */
#define __ALIGN_BEGIN
#endif
#endif
#endif

static void TxCallback(I2S_Type *base, i2s_dma_handle_t *handle,
		status_t completionStatus, void *userData);

/* 100 samples => time about 2 ms */
//__ALIGN_BEGIN static uint8_t s_Buffer[400] __ALIGN_END;
static dma_handle_t s_DmaTxHandle;
static i2s_config_t s_TxConfig;
static i2s_dma_handle_t s_TxHandle;
static i2s_transfer_t s_TxTransfer;

/*!
 * @brief One period of sine wave in 108 32-bit samples.
 * One sample contains two 16-bit channels.
 */
/*__ALIGN_BEGIN uint8_t g_Music[] __ALIGN_END = {
    0x00U, 0x00U, 0x00U, 0x00U, 0x71U, 0x07U, 0x71U, 0x07U, 0xDCU, 0x0EU, 0xDCU, 0x0EU, 0x39U, 0x16U, 0x39U, 0x16U,
    0x84U, 0x1DU, 0x84U, 0x1DU, 0xB5U, 0x24U, 0xB5U, 0x24U, 0xC6U, 0x2BU, 0xC6U, 0x2BU, 0xB2U, 0x32U, 0xB2U, 0x32U,
    0x71U, 0x39U, 0x71U, 0x39U, 0xFFU, 0x3FU, 0xFFU, 0x3FU, 0x55U, 0x46U, 0x55U, 0x46U, 0x6FU, 0x4CU, 0x6FU, 0x4CU,
    0x46U, 0x52U, 0x46U, 0x52U, 0xD6U, 0x57U, 0xD6U, 0x57U, 0x19U, 0x5DU, 0x19U, 0x5DU, 0x0CU, 0x62U, 0x0CU, 0x62U,
    0xABU, 0x66U, 0xABU, 0x66U, 0xF0U, 0x6AU, 0xF0U, 0x6AU, 0xD9U, 0x6EU, 0xD9U, 0x6EU, 0x61U, 0x72U, 0x61U, 0x72U,
    0x87U, 0x75U, 0x87U, 0x75U, 0x46U, 0x78U, 0x46U, 0x78U, 0x9EU, 0x7AU, 0x9EU, 0x7AU, 0x8BU, 0x7CU, 0x8BU, 0x7CU,
    0x0DU, 0x7EU, 0x0DU, 0x7EU, 0x21U, 0x7FU, 0x21U, 0x7FU, 0xC7U, 0x7FU, 0xC7U, 0x7FU, 0xFEU, 0x7FU, 0xFEU, 0x7FU,
    0xC7U, 0x7FU, 0xC7U, 0x7FU, 0x21U, 0x7FU, 0x21U, 0x7FU, 0x0DU, 0x7EU, 0x0DU, 0x7EU, 0x8BU, 0x7CU, 0x8BU, 0x7CU,
    0x9EU, 0x7AU, 0x9EU, 0x7AU, 0x46U, 0x78U, 0x46U, 0x78U, 0x87U, 0x75U, 0x87U, 0x75U, 0x61U, 0x72U, 0x61U, 0x72U,
    0xD9U, 0x6EU, 0xD9U, 0x6EU, 0xF0U, 0x6AU, 0xF0U, 0x6AU, 0xABU, 0x66U, 0xABU, 0x66U, 0x0CU, 0x62U, 0x0CU, 0x62U,
    0x19U, 0x5DU, 0x19U, 0x5DU, 0xD6U, 0x57U, 0xD6U, 0x57U, 0x46U, 0x52U, 0x46U, 0x52U, 0x6FU, 0x4CU, 0x6FU, 0x4CU,
    0x55U, 0x46U, 0x55U, 0x46U, 0xFFU, 0x3FU, 0xFFU, 0x3FU, 0x71U, 0x39U, 0x71U, 0x39U, 0xB2U, 0x32U, 0xB2U, 0x32U,
    0xC6U, 0x2BU, 0xC6U, 0x2BU, 0xB5U, 0x24U, 0xB5U, 0x24U, 0x84U, 0x1DU, 0x84U, 0x1DU, 0x39U, 0x16U, 0x39U, 0x16U,
    0xDCU, 0x0EU, 0xDCU, 0x0EU, 0x71U, 0x07U, 0x71U, 0x07U, 0x00U, 0x00U, 0x00U, 0x00U, 0x8FU, 0xF8U, 0x8FU, 0xF8U,
    0x24U, 0xF1U, 0x24U, 0xF1U, 0xC7U, 0xE9U, 0xC7U, 0xE9U, 0x7CU, 0xE2U, 0x7CU, 0xE2U, 0x4BU, 0xDBU, 0x4BU, 0xDBU,
    0x3AU, 0xD4U, 0x3AU, 0xD4U, 0x4EU, 0xCDU, 0x4EU, 0xCDU, 0x8FU, 0xC6U, 0x8FU, 0xC6U, 0x01U, 0xC0U, 0x01U, 0xC0U,
    0xABU, 0xB9U, 0xABU, 0xB9U, 0x91U, 0xB3U, 0x91U, 0xB3U, 0xBAU, 0xADU, 0xBAU, 0xADU, 0x2AU, 0xA8U, 0x2AU, 0xA8U,
    0xE7U, 0xA2U, 0xE7U, 0xA2U, 0xF4U, 0x9DU, 0xF4U, 0x9DU, 0x55U, 0x99U, 0x55U, 0x99U, 0x10U, 0x95U, 0x10U, 0x95U,
    0x27U, 0x91U, 0x27U, 0x91U, 0x9FU, 0x8DU, 0x9FU, 0x8DU, 0x79U, 0x8AU, 0x79U, 0x8AU, 0xBAU, 0x87U, 0xBAU, 0x87U,
    0x62U, 0x85U, 0x62U, 0x85U, 0x75U, 0x83U, 0x75U, 0x83U, 0xF3U, 0x81U, 0xF3U, 0x81U, 0xDFU, 0x80U, 0xDFU, 0x80U,
    0x39U, 0x80U, 0x39U, 0x80U, 0x02U, 0x80U, 0x02U, 0x80U, 0x39U, 0x80U, 0x39U, 0x80U, 0xDFU, 0x80U, 0xDFU, 0x80U,
    0xF3U, 0x81U, 0xF3U, 0x81U, 0x75U, 0x83U, 0x75U, 0x83U, 0x62U, 0x85U, 0x62U, 0x85U, 0xBAU, 0x87U, 0xBAU, 0x87U,
    0x79U, 0x8AU, 0x79U, 0x8AU, 0x9FU, 0x8DU, 0x9FU, 0x8DU, 0x27U, 0x91U, 0x27U, 0x91U, 0x10U, 0x95U, 0x10U, 0x95U,
    0x55U, 0x99U, 0x55U, 0x99U, 0xF4U, 0x9DU, 0xF4U, 0x9DU, 0xE7U, 0xA2U, 0xE7U, 0xA2U, 0x2AU, 0xA8U, 0x2AU, 0xA8U,
    0xBAU, 0xADU, 0xBAU, 0xADU, 0x91U, 0xB3U, 0x91U, 0xB3U, 0xABU, 0xB9U, 0xABU, 0xB9U, 0x01U, 0xC0U, 0x01U, 0xC0U,
    0x8FU, 0xC6U, 0x8FU, 0xC6U, 0x4EU, 0xCDU, 0x4EU, 0xCDU, 0x3AU, 0xD4U, 0x3AU, 0xD4U, 0x4BU, 0xDBU, 0x4BU, 0xDBU,
    0x7CU, 0xE2U, 0x7CU, 0xE2U, 0xC7U, 0xE9U, 0xC7U, 0xE9U, 0x24U, 0xF1U, 0x24U, 0xF1U, 0x8FU, 0xF8U, 0x8FU, 0xF8U,
};*/

/*__ALIGN_BEGIN uint8_t g_Music[] __ALIGN_END = {
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U, 0x00U,
};*/

__ALIGN_BEGIN uint8_t g_Music[] __ALIGN_END = {
		  0x00U, 0x00U, 0x00U, 0x00U,
		  0x0dU, 0x85U, 0x09U, 0x08U,
		  0x5dU, 0xebU, 0x0aU, 0x10U,
		  0x64U, 0x1cU, 0xfcU, 0x17U,
		  0xf9U, 0x11U, 0xd5U, 0x1fU,
		  0x6eU, 0xdeU, 0x8dU, 0x27U,
		  0x90U, 0xb4U, 0x1eU, 0x2fU,
		  0x91U, 0xefU, 0x7fU, 0x36U,
		  0xb9U, 0x1aU, 0xaaU, 0x3dU,
		  0xefU, 0xf8U, 0x95U, 0x44U,
		  0x11U, 0x8cU, 0x3cU, 0x4bU,
		  0xfaU, 0x1bU, 0x97U, 0x51U,
		  0x53U, 0x3dU, 0x9fU, 0x57U,
		  0x0eU, 0xd8U, 0x4eU, 0x5dU,
		  0x8cU, 0x2dU, 0xa0U, 0x62U,
		  0x6dU, 0xdeU, 0x8dU, 0x67U,
		  0xfcU, 0xefU, 0x12U, 0x6cU,
		  0x39U, 0xd1U, 0x2aU, 0x70U,
		  0x72U, 0x5fU, 0xd1U, 0x73U,
		  0x76U, 0xeaU, 0x02U, 0x77U,
		  0x4cU, 0x38U, 0xbcU, 0x79U,
		  0x73U, 0x88U, 0xfaU, 0x7bU,
		  0xafU, 0x96U, 0xbbU, 0x7dU,
		  0x51U, 0x9dU, 0xfdU, 0x7eU,
		  0xfeU, 0x56U, 0xbfU, 0x7fU,
		  0xffU, 0xffU, 0xffU, 0x7fU,
		  0xfeU, 0x56U, 0xbfU, 0x7fU,
		  0x51U, 0x9dU, 0xfdU, 0x7eU,
		  0xafU, 0x96U, 0xbbU, 0x7dU,
		  0x73U, 0x88U, 0xfaU, 0x7bU,
		  0x4cU, 0x38U, 0xbcU, 0x79U,
		  0x76U, 0xeaU, 0x02U, 0x77U,
		  0x72U, 0x5fU, 0xd1U, 0x73U,
		  0x39U, 0xd1U, 0x2aU, 0x70U,
		  0xfcU, 0xefU, 0x12U, 0x6cU,
		  0x6dU, 0xdeU, 0x8dU, 0x67U,
		  0x8cU, 0x2dU, 0xa0U, 0x62U,
		  0x0eU, 0xd8U, 0x4eU, 0x5dU,
		  0x53U, 0x3dU, 0x9fU, 0x57U,
		  0xfaU, 0x1bU, 0x97U, 0x51U,
		  0x11U, 0x8cU, 0x3cU, 0x4bU,
		  0xefU, 0xf8U, 0x95U, 0x44U,
		  0xb9U, 0x1aU, 0xaaU, 0x3dU,
		  0x91U, 0xefU, 0x7fU, 0x36U,
		  0x90U, 0xb4U, 0x1eU, 0x2fU,
		  0x6eU, 0xdeU, 0x8dU, 0x27U,
		  0xf9U, 0x11U, 0xd5U, 0x1fU,
		  0x64U, 0x1cU, 0xfcU, 0x17U,
		  0x5dU, 0xebU, 0x0aU, 0x10U,
		  0x0dU, 0x85U, 0x09U, 0x08U,
		  0x00U, 0x00U, 0x00U, 0x00U,
		  0xf3U, 0x7aU, 0xf6U, 0xf7U,
		  0xa3U, 0x14U, 0xf5U, 0xefU,
		  0x9cU, 0xe3U, 0x03U, 0xe8U,
		  0x07U, 0xeeU, 0x2aU, 0xe0U,
		  0x92U, 0x21U, 0x72U, 0xd8U,
		  0x70U, 0x4bU, 0xe1U, 0xd0U,
		  0x6fU, 0x10U, 0x80U, 0xc9U,
		  0x47U, 0xe5U, 0x55U, 0xc2U,
		  0x11U, 0x07U, 0x6aU, 0xbbU,
		  0xefU, 0x73U, 0xc3U, 0xb4U,
		  0x06U, 0xe4U, 0x68U, 0xaeU,
		  0xadU, 0xc2U, 0x60U, 0xa8U,
		  0xf2U, 0x27U, 0xb1U, 0xa2U,
		  0x74U, 0xd2U, 0x5fU, 0x9dU,
		  0x93U, 0x21U, 0x72U, 0x98U,
		  0x04U, 0x10U, 0xedU, 0x93U,
		  0xc7U, 0x2eU, 0xd5U, 0x8fU,
		  0x8eU, 0xa0U, 0x2eU, 0x8cU,
		  0x8aU, 0x15U, 0xfdU, 0x88U,
		  0xb4U, 0xc7U, 0x43U, 0x86U,
		  0x8dU, 0x77U, 0x05U, 0x84U,
		  0x51U, 0x69U, 0x44U, 0x82U,
		  0xafU, 0x62U, 0x02U, 0x81U,
		  0x02U, 0xa9U, 0x40U, 0x80U,
		  0x01U, 0x00U, 0x00U, 0x80U,
		  0x02U, 0xa9U, 0x40U, 0x80U,
		  0xafU, 0x62U, 0x02U, 0x81U,
		  0x51U, 0x69U, 0x44U, 0x82U,
		  0x8dU, 0x77U, 0x05U, 0x84U,
		  0xb4U, 0xc7U, 0x43U, 0x86U,
		  0x8aU, 0x15U, 0xfdU, 0x88U,
		  0x8eU, 0xa0U, 0x2eU, 0x8cU,
		  0xc7U, 0x2eU, 0xd5U, 0x8fU,
		  0x04U, 0x10U, 0xedU, 0x93U,
		  0x93U, 0x21U, 0x72U, 0x98U,
		  0x74U, 0xd2U, 0x5fU, 0x9dU,
		  0xf2U, 0x27U, 0xb1U, 0xa2U,
		  0xadU, 0xc2U, 0x60U, 0xa8U,
		  0x06U, 0xe4U, 0x68U, 0xaeU,
		  0xefU, 0x73U, 0xc3U, 0xb4U,
		  0x11U, 0x07U, 0x6aU, 0xbbU,
		  0x47U, 0xe5U, 0x55U, 0xc2U,
		  0x6fU, 0x10U, 0x80U, 0xc9U,
		  0x70U, 0x4bU, 0xe1U, 0xd0U,
		  0x92U, 0x21U, 0x72U, 0xd8U,
		  0x07U, 0xeeU, 0x2aU, 0xe0U,
		  0x9cU, 0xe3U, 0x03U, 0xe8U,
		  0xa3U, 0x14U, 0xf5U, 0xefU,
		  0xf3U, 0x7aU, 0xf6U, 0xf7U,
};


void AUDIO_Init() {
	/* reset FLEXCOMM for I2S */
	RESET_PeripheralReset(kFC7_RST_SHIFT_RSTn);
	/* reset NVIC for FLEXCOMM7 */
	NVIC_ClearPendingIRQ(FLEXCOMM7_IRQn);

    /*
     * masterSlave = kI2S_MasterSlaveNormalSlave;
     * mode = kI2S_ModeI2sClassic;
     * rightLow = false;
     * leftJust = false;
     * pdmData = false;
     * sckPol = false;
     * wsPol = false;
     * divider = 1;
     * oneChannel = false;
     * dataLength = 16;
     * frameLength = 32;
     * position = 0;
     * watermark = 4;
     * txEmptyZero = true;
     * pack48 = false;
     */
    I2S_TxGetDefaultConfig(&s_TxConfig);
    s_TxConfig.divider = I2S_CLOCK_DIVIDER;
    s_TxConfig.masterSlave = ADUIO_I2S_TX_MODE;
    s_TxConfig.dataLength = AUDIO_I2S_DATA;
    s_TxConfig.frameLength = AUDIO_I2S_FRAME;
    I2S_TxInit(AUDIO_I2S_TX, &s_TxConfig);

    DMA_Init(AUDIO_DMA);

	DMA_EnableChannel(AUDIO_DMA, AUDIO_I2S_TX_CHANNEL);
	DMA_SetChannelPriority(AUDIO_DMA, AUDIO_I2S_TX_CHANNEL,
			kDMA_ChannelPriority3);
	DMA_CreateHandle(&s_DmaTxHandle, AUDIO_DMA, AUDIO_I2S_TX_CHANNEL);
}

void AUDIO_Start() {
	s_TxTransfer.data     = &g_Music[0];
	s_TxTransfer.dataSize = sizeof(g_Music);

	I2S_TxTransferCreateHandleDMA(AUDIO_I2S_TX, &s_TxHandle, &s_DmaTxHandle,
			TxCallback, (void *)&s_TxTransfer);
	/* need to queue two transmit buffers so when the first one
	 * finishes transfer, the other immediatelly starts */
	I2S_TxTransferSendDMA(AUDIO_I2S_TX, &s_TxHandle, s_TxTransfer);
	I2S_TxTransferSendDMA(AUDIO_I2S_TX, &s_TxHandle, s_TxTransfer);
}

static void TxCallback(I2S_Type *base, i2s_dma_handle_t *handle,
		status_t completionStatus, void *userData) {
    /* Enqueue the same original buffer all over again */
    i2s_transfer_t *transfer = (i2s_transfer_t *)userData;
    I2S_TxTransferSendDMA(base, handle, *transfer);
}
